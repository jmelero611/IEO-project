---
output:
  BiocStyle::html_document
---


```{r setup, cache=FALSE, echo=FALSE, results='hide', message=FALSE}
library(knitr)
library(SummarizedExperiment)
library(edgeR)
library(geneplotter)

opts_chunk$set(cache=TRUE,
               cache.path="cache/file2",
               cache.extra=R.version.string,
               autodep=TRUE,
               fig.align="center",
               comment="")

se <- readRDS(file.path("rawCounts", "seLUSC.rds"))
dge <- readRDS(file.path("results", "dge.rds"))
se.filt.unnorm <- readRDS(file.path("results", "se.filt.unnorm.rds"))
dge.filt.unnorm <- readRDS(file.path("results", "dge.filt.unnorm.rds"))
se.filt <- readRDS(file.path("results", "se.filt.rds"))
dge.filt <- readRDS(file.path("results", "dge.filt.rds"))
se.flit.batch <- readRDS(file.path("results", "se.filt.batch.rds"))
dge.filt.batch <- readRDS(file.path("results", "dge.filt.batch.rds"))

```

We perform a simple examination of expression changes and their associated p-values
using the R/Bioconductor package [sva](http://bioconductor.org/packages/sva).

Now, we are going to performe a surrogate variable analysis (SVA) to try to capture sources of heterogeneity in our data that are introducing variability by batch effects. We will obtain the number of "surrogate variables" and their continuous values. Later we will use them to adjust for these unmeasured and unwanted effects.

We start building the design matrix of the full model. Next, create the design matrix of the null model. When there were no factor to adjust we would just give the intercept term by writing ~ 1 in the model formula:

```{r}
mod <- model.matrix(~se.filt$type, data = colData(se.filt))
#mod <- model.matrix(~se.filt.batch$type, data = colData(se.filt.batch))
head(mod)
mod0 <- model.matrix(~1, data = colData(se.filt))
```

We estimate the surrogate variables:

```{r}
library("sva")
sv <- sva(assays(se.filt)$logCPM, mod, mod0)
#sv <- sva(assays(se.filt.batch)$logCPM, mod, mod0)
names(sv)
```

Then we examine how many genes change across conditions without adjustment. It is useful for comparing the model with and without surrogate variables, even we are using the logCPM that is not the best approach.

```{r}
pValues <- f.pvalue(logCPM, mod, mod0)
sum(p.adjust(pValues, method = "BH") < 0.01)
```

There are `r sum(p.adjust(pValues, method = "BH") < 0.01)` differentially expressed genes with FDR < 1%.

Examine the p-values distribution:

```{r}
hist(pValues, main = "", las = 1)
```

A distribution of p-values under the null hypothesis should be uniform. Assuming that most genes are not differentially expressed (DE), the previous histogram should have looked uniform with a peak at low p-values for the truly DE genes. Departures from this indicate data heterogeneity. The peak of the truly differential expressed genes seems to be too big to be sure if the rest of the distribution is uniform. 

Number of changes when we adjust for the estimated surrogate variables:

```{r}
modSv <- cbind(mod, sv$sv)
mod0Sv <- cbind(mod0, sv$sv)
pValuesSv <- f.pvalue(assays(se.filt)$logCPM, modSv, mod0Sv)
sum(p.adjust(pValuesSv, method = "BH") < 0.01)
```

The number of changing genes has increased from `r sum(p.adjust(pValues, method = "BH") < 0.01)` to `r sum(p.adjust(pValuesSv, method = "BH") < 0.01)` and the p-value distribution is more uniform now for the non-DE genes.

```{r}
hist(pValuesSv, main = "", las = 1)
```

Now it looks more uniform for non DE-genes...

Just to see a little bit more the genes that are really differentially expressed, we plot a volcano plot with the p-values corrected for the surrogated variables.

```{r}
tumorExp <- rowMeans(assays(se.filt)$logCPM[, se.filt$type == "tumor"])
normalExp <- rowMeans(assays(se.filt)$logCPM[, se.filt$type == "normal"])

log2fc <- tumorExp - normalExp
head(log2fc)

tab <- data.frame(Log2FC = round(log2fc, digits = 3), Pvalue = pValuesSv)
tab$FDRpvalue <- p.adjust(tab$Pvalue, method = "fdr")
length(tab$Log2FC)
length(tab$Pvalue)


plot(tab$Log2FC, -log10(tab$Pvalue), pch=".", cex=3, xlab="Log fold-change", ylab="Raw p-value", las=1)
abline(h=-log10(max(tab$Pvalue[tab$FDRpvalue <= 0.01])), lty=2)


```

As we can see in the volcano plot, there are a lot of genes with an FDR < 0.01.


## Session information

```{r, message=FALSE}
sessionInfo()
```